<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actualizar contraseña</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="login-container">
        <h2>Actualizar contraseña</h2>
        <form id="forgot-form">
            <div class="input-group">
                <label for="username">Usuario (username):</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="input-group">
                <label for="password">Nueva contraseña:</label>
                <input type="password" id="password" name="password" required>
            </div>
            <div class="input-group">
                <label for="old_password">Contraseña actual:</label>
                <input type="password" id="old_password" name="old_password" required>
            </div>
            <div class="input-group">
                <label for="confirm">Confirmar contraseña:</label>
                <input type="password" id="confirm" name="confirm" required>
            </div>
            <button type="submit">Actualizar contraseña</button>
            <div id="msg" class="error-message" style="margin-top:8px"></div>
        </form>
        <div style="margin-top:12px;text-align:center"><a href="/">Volver</a></div>
    </div>

    <script>
    (function(){
        // Pre-fill sistema if present in query string
        const params = new URLSearchParams(window.location.search);
        const sistema = params.get('sistema');
        // Optionally you could show the sistema to the user or hide it

        document.getElementById('forgot-form').addEventListener('submit', async function(e){
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const old_password = document.getElementById('old_password').value;
            const confirm = document.getElementById('confirm').value;
            const msg = document.getElementById('msg');
            msg.textContent = '';
            if(!username || !password || !confirm){ msg.textContent = 'Todos los campos son obligatorios.'; return; }
            if(password !== confirm){ msg.textContent = 'Las contraseñas no coinciden.'; return; }

            try{
                const payload = { username, password, old_password };
                if (sistema) payload.sistema = sistema;
                const res = await fetch('/forgot_password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const j = await res.json();
                if(j.ok){ msg.style.color = 'green'; msg.textContent = 'Contraseña actualizada correctamente.'; }
                else { msg.style.color = 'red'; msg.textContent = j.error || 'Error al actualizar.'; }
            }catch(err){ msg.style.color = 'red'; msg.textContent = 'Error de conexión.'; }
        });
    })();
    </script>
</body>
</html>